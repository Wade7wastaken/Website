const linksperpage=100;let linknames=[],emugames,page=0;const games=[],matches=[],filteredsites=[],mainPrm=(console.log("Advanced features:"),console.log('Set local storage "origin" to "0" to run the emulator hosted on this domain, and "1" to run it from GitHub.'),console.log('Set local storage "emuWidth" and "emuHeight" to set a custom size for EmulatorJS.'),(async()=>{try{await fetchLinks(),getLocalStorage(),loadEmuGames(),addSiteSelectors(),sortLinks(),renderLinks(),updateTabs(localStorage.openTab),doneLoading()}catch(e){loadError("Generic error",e)}})());async function fetchLinks(){function e(e){var t=document.createElement("a");for(const o in e){linknames.push(o);var a=e[o];if("flash"==o)for(const n of a)"string"!=typeof n&&(games.push([n[0],"./ruffle.html?game="+n[1],"Flash (Ruffle)","local"]),games.push([n[0],"./waflash.html?game="+n[1],"Flash (WAFlash)","local"]));else for(const s of a)t.href=s[1],games.push([s[0],s[1],o,t.hostname])}}await Promise.all(function(e){const a=[];return e.forEach(t=>{a.push(fetch(`./data/${t[0]}.json`).then(e=>e.json()).then(e=>{t[1](e)}).catch(e=>{loadError("Error fetching "+t[0],e)}))}),a}([["scrapelinks",e],["customlinks",e],["emugames",e=>{emugames=e}]])).then(()=>{games.sort(),(linknames=linknames.concat(["Flash (Ruffle)","Flash (WAFlash)"]).remove("flash").sort()).remove("Other"),linknames.push("Other")}).catch(e=>{loadError("Error fetching/processing json data",e)})}function getLocalStorage(){switch(localStorage.openTab||(localStorage.openTab="Web"),"1"==localStorage.oldCores&&(getId("coretoggle").className+=" active"),localStorage.emu){case"EJS":getId("emulatortoggle").textContent="EmulatorJS";break;case"NJS":getId("emulatortoggle").textContent="NeptunJS",getId("coretoggle").style.display="none";break;default:getId("emulatortoggle").textContent="EmulatorJS"}}async function updateTabs(t){await mainPrm,localStorage.openTab=t;var a=getClass("tabcontent");for(let e=0;e<a.length;e++)a[e].style.display="none";getId(t).style.display="block";var o=getClass("tabbuttons");for(let e=0;e<o.length;e++)o[e].className=o[e].className.replace(" active",""),o[e].className.includes(t)&&(o[e].className+=" active");var e,n="Web"==t?"none":"block";for(e of getClass("webhidden"))e.style.display=n}function doneLoading(){getId("loadscreen").style.display="none"}function loadError(e,t){throw getId("errmsg").innerHTML=e+": "+t,Array.from(getClass("loadtext")).forEach(e=>{e.style.color="red"}),Array.from(getClass("error")).forEach(e=>{e.style.display="block"}),Array.from(getClass("noerror")).forEach(e=>{e.style.display="none"}),t}function loadEmuGames(){var e=getId("buttonparent"),t=document.createElement("button"),a=document.createElement("li"),o=document.createElement("a"),n=(a.append(o),document.createElement("button"));n.textContent="Web",n.className="tabbuttons Web",n.setAttribute("onclick",'updateTabs("Web")'),e.append(n);for(const i in emugames){var s=emugames[i],l=(t.textContent=s.name,t.className="tabbuttons "+i,t.setAttribute("onclick",`updateTabs("${i}")`),e.append(t.cloneNode(!0)),getId(i));quickAppend("h2",l,s.name);for(const m in s.games){var r=s.games[m];quickAppend("h3",l,m);for(const g in r){category=r[g],"main"!=g&&quickAppend("h4",l,g);var c=document.createElement("ul");for(const d of category)o.textContent=d.name,o.href=`game.html?ver=${s.consolename}&game=`+d.rom,c.append(a.cloneNode(!0));l.append(c)}}}}function loadLinks(){var e=document.createElement("a");for(const a in links){var t=links[a];if("flash"==a)for(const o of t)games.push([o[0],"./ruffle.html?game="+o[1],"Flash (Ruffle)","local"]),games.push([o[0],"./waflash.html?game="+o[1],"Flash (WAFlash)","local"]);else for(const n of t)e.href=n[1],games.push([n[0],n[1],a,e.hostname])}games.sort()}function addSiteSelectors(){const t=getId("siteselector"),a=document.createElement("button");a.className="buttonslim",a.setAttribute("onclick","togglesites(event);"),linknames.forEach(e=>{a.textContent=e,a.setAttribute("data",e),t.appendChild(a.cloneNode(!0))})}function sortLinks(){matches.length=0;for(const e of games)e[0].toLowerCase().includes(getId("websearch").value.toLowerCase())&&!filteredsites.includes(e[2])&&matches.push(e)}function renderLinks(){var e=getId("webgames"),t=(e.innerHTML="",document.createElement("div")),a=(t.className="webcontent",document.createElement("a")),o=(a.className="weblinks",a.setAttribute("target","_blank"),document.createElement("p")),n=(o.className="domainname",t.appendChild(a),t.appendChild(o),page*linksperpage);for(const s of matches.slice(n,n+linksperpage))a.textContent=s[0]+" - "+s[2],a.href=s[1],a.style.color="hsl("+360/linknames.length*linknames.indexOf(s[2])+", 100%, 85%)",o.textContent="("+s[3]+")",e.appendChild(t.cloneNode(!0));n=getClass("pagedisplay");Array.from(n).forEach(e=>{e.textContent=`Page ${page+1} of `+(Math.floor(matches.length/linksperpage)+1)})}async function toggleEmulator(){await mainPrm;var e=getId("emulatortoggle");"EmulatorJS"==e.textContent?(localStorage.emu="NJS",e.textContent="NeptunJS",getId("coretoggle").style.display="none"):(localStorage.emu="EJS",e.textContent="EmulatorJS",getId("coretoggle").style.display="inline-block")}async function toggleoldcores(){await mainPrm;var e=getId("coretoggle"),t=e.className.split(" ");t.includes("active")?(t.remove("active"),localStorage.oldCores="0"):(localStorage.oldCores="1",t.push("active")),e.className=t.join(" ")}async function togglesites(e){await mainPrm;var e=e.currentTarget,t=e.className.split(" ");t.includes("active")?(t.remove("active"),filteredsites.remove(e.attributes.data.nodeValue)):(t.push("active"),filteredsites.push(e.attributes.data.nodeValue)),e.className=t.join(" "),onSearchInput()}async function nextPage(){await mainPrm,page!=Math.floor(matches.length/linksperpage)&&(page+=1,renderLinks())}async function prevPage(){await mainPrm,0!=page&&(--page,renderLinks())}async function onSearchInput(){await mainPrm,page=0,sortLinks(),renderLinks()}async function randomGame(){await mainPrm,window.open(matches[Math.floor(Math.random()*matches.length)][1])}